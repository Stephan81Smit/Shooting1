<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Telescope Sniper Elite - Fun Edition</title>
    <script src="https://kaboomjs.com/lib/0.7.2/kaboom.js"></script>
    <style>
        body, html { margin: 0; padding: 0; overflow: hidden; background: #000; }
        canvas { display: block; }
    </style>
</head>
<body>
    <div id="game"></div>
    <script>
        kaboom({
            width: 1024,
            height: 768,
            letterbox: true,
            touchToMouse: true,
            canvas: document.querySelector("#game"),
            background: [10, 10, 20]
        });

        // ASSET LOADING
        loadSound("shot", "https://files.catbox.moe/3u5yjn.mp3");
        loadSound("hit", "https://files.catbox.moe/4mfc9a.mp3");
        loadSound("reloadSfx", "https://files.catbox.moe/zz7p0x.mp3");
        loadSound("waveClear", "https://files.catbox.moe/gr7i2b.mp3");
        loadSound("comboBreak", "https://files.catbox.moe/4wv0d0.mp3");

        // --- SCENE 1: MAIN MENU ---
        scene("menu", () => {
            add([
                text("Telescope Sniper", { size: 64, align: "center" }),
                pos(center().x, height() * 0.3),
                anchor("center")
            ]);

            const playBtn = add([
                rect(240, 80, { radius: 10 }),
                pos(center()),
                outline(4),
                area(),
                anchor("center"),
                color(0, 1, 0)
            ]);
            add([ text("Play", { size: 48 }), pos(center()), anchor("center") ]);

            playBtn.onClick(() => go("tutorial"));
        });

        // --- SCENE 2: TUTORIAL ---
        scene("tutorial", () => {
            add([
                text("TUTORIAL", { size: 48 }),
                pos(center().x, height() * 0.2),
                anchor("center")
            ]);
            add([
                text("Tilt Your Phone to Aim.\nTap FIRE to Shoot.", { size: 32, align: "center", width: width() * 0.8 }),
                pos(center().x, height() * 0.4),
                anchor("center")
            ]);
            const startBtn = add([
                rect(300, 80, { radius: 10 }),
                pos(center().x, height() * 0.7),
                outline(4), area(), anchor("center"), color(0, 1, 0)
            ]);
            add([ text("Calibrate & Start", { size: 32 }), pos(center().x, height() * 0.7), anchor("center") ]);
            
            startBtn.onClick(() => go("game"));
        });

        // --- SCENE 3: GAME ---
        scene("game", () => {
            // GAME STATE
            const gameState = {
                score: 0,
                ammo: 6,
                reloading: false,
                wave: 0,
                combo: 1,
                highestCombo: 1,
                waveTimer: 0,
                targetsRemaining: 0,
            };

            // GYRO AIMING
            const gyro = { sensitivity: 0.1, x: 0, y: 0 };
            function handleMotion(event) {
                const rot = event.rotationRate;
                gyro.x += rot.beta * gyro.sensitivity;
                gyro.y += rot.alpha * gyro.sensitivity;
                const cam = camPos();
                camPos(clamp(cam.x + gyro.y, 0, width()), clamp(cam.y + gyro.x, 0, height()));
            }
            if (typeof DeviceMotionEvent.requestPermission === 'function') {
                DeviceMotionEvent.requestPermission().then(state => {
                    if (state === 'granted') window.addEventListener('devicemotion', handleMotion);
                });
            } else {
                window.addEventListener('devicemotion', handleMotion);
            }

            // UI ELEMENTS
            const scoreUI = add([ pos(20, 20), text("Score: 0", { size: 28 }), fixed(), anchor('top-left'), z(100) ]);
            const ammoUI = add([ pos(width() - 20, 20), text("Ammo: 6", { size: 28 }), fixed(), anchor('top-right'), z(100) ]);
            const waveUI = add([ pos(center().x, 20), text("Wave: 1", { size: 32 }), fixed(), anchor('top'), z(100) ]);
            const comboUI = add([ pos(20, height() - 20), text("", { size: 32, font: "sans-serif" }), fixed(), anchor('bot-left'), z(100) ]);
            const timerUI = add([ pos(width() / 2, height() - 20), text("Time: 30", { size: 28 }), fixed(), anchor('bot'), z(100) ]);

            // NOTIFICATION SYSTEM
            function showNotification(txt, p, col = [255, 255, 255]) {
                add([
                    text(txt, { size: 24 }),
                    pos(p),
                    lifespan(1, { fade: 0.5 }),
                    move(UP, 60),
                    color(...col),
                    z(200)
                ]);
            }

            // WAVE SYSTEM
            function startWave(waveNum) {
                gameState.wave = waveNum;
                gameState.targetsRemaining = 2 + waveNum * 2; // Increase targets per wave
                gameState.waveTimer = 20 + waveNum * 5; // More time for later waves
                waveUI.text = `Wave: ${waveNum}`;
                showNotification(`WAVE ${waveNum}`, center(), [0, 255, 0]);
                for (let i = 0; i < gameState.targetsRemaining; i++) {
                    wait(rand(0.1, 1.5), spawnTarget);
                }
            }

            function spawnTarget() {
                add([
                    rect(40, 40), pos(rand(0, width()), rand(0, height())), color(1, 0.2, 0.2), area(), "target",
                    { speed: rand(100 + gameState.wave * 10, 200 + gameState.wave * 20) },
                    lifespan(10) // Targets despawn if not shot
                ]);
            }

            // CONTROLS
            const fireButton = add([ pos(width() - 80, height() - 80), circle(60), color(0, 0, 0, 0.5), outline(4, [255, 255, 255]), area(), fixed(), anchor('bot-right'), z(200) ]);
            fireButton.onClick(() => {
                if (gameState.reloading || gameState.ammo <= 0) return;
                
                gameState.ammo--;
                play("shot");
                const shotPos = camPos();
                const hit = get("target").find(t => t.hasPoint(shotPos));

                if (hit) {
                    play("hit");
                    destroy(hit);
                    gameState.targetsRemaining--;
                    const points = 100 * gameState.combo;
                    gameState.score += points;
                    gameState.combo++;
                    if(gameState.combo > gameState.highestCombo) gameState.highestCombo = gameState.combo;

                    showNotification(`+${points}`, hit.pos);
                    showNotification(`x${gameState.combo} COMBO!`, hit.pos.add(0, 30), [255, 255, 0]);
                } else { // Miss
                    if (gameState.combo > 1) {
                        play("comboBreak");
                        showNotification("COMBO LOST", camPos(), [255, 0, 0]);
                    }
                    gameState.combo = 1;
                }

                if (gameState.ammo === 0) reload();
            });

            function reload() {
                if (gameState.reloading) return;
                play("reloadSfx");
                gameState.reloading = true;
                wait(2, () => {
                    gameState.ammo = 6;
                    gameState.reloading = false;
                });
            }

            // GAME LOOP
            onUpdate(() => {
                gameState.waveTimer -= dt(); // dt() is delta time
                // Update UI
                scoreUI.text = `Score: ${gameState.score}`;
                ammoUI.text = gameState.reloading ? `RELOADING` : `Ammo: ${gameState.ammo}`;
                fireButton.color = gameState.ammo > 0 ? rgb(0,0,0,0.5) : rgb(1,0,0,0.5);
                comboUI.text = gameState.combo > 1 ? `COMBO x${gameState.combo}` : "";
                comboUI.color = gameState.combo > 5 ? rgb(1, 0.5, 0) : rgb(1,1,1);
                timerUI.text = `Time: ${Math.max(0, Math.round(gameState.waveTimer))}`;
                timerUI.color = gameState.waveTimer < 5 ? rgb(1,0,0) : rgb(1,1,1);

                // Game Logic Checks
                if (gameState.targetsRemaining <= 0) {
                    play("waveClear");
                    gameState.score += Math.round(gameState.waveTimer) * 50; // Time bonus
                    showNotification(`TIME BONUS +${Math.round(gameState.waveTimer) * 50}`, center());
                    startWave(gameState.wave + 1);
                }
                if (gameState.waveTimer <= 0) {
                    go("gameOver", { score: gameState.score, wave: gameState.wave, combo: gameState.highestCombo });
                }
            });

            startWave(1); // Let's begin!
        });

        // --- SCENE 4: GAME OVER ---
        scene("gameOver", ({ score, wave, combo }) => {
            add([ text("GAME OVER", { size: 64 }), pos(center().x, height() * 0.2), anchor("center"), color(1, 0, 0) ]);
            add([ text(`Final Score: ${score}`, { size: 40 }), pos(center().x, height() * 0.4), anchor("center") ]);
            add([ text(`Waves Cleared: ${wave - 1}`, { size: 32 }), pos(center().x, height() * 0.5), anchor("center") ]);
            add([ text(`Highest Combo: x${combo}`, { size: 32 }), pos(center().x, height() * 0.6), anchor("center") ]);
            
            const retryBtn = add([ rect(240, 80, { radius: 10 }), pos(center().x, height() * 0.8), outline(4), area(), anchor("center"), color(0,1,0) ]);
            add([ text("Play Again", { size: 32 }), pos(center().x, height() * 0.8), anchor("center") ]);

            retryBtn.onClick(() => go("game"));
        });

        go("menu");
    </script>
</body>
</html>
