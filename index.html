<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Telescope Sniper - Immersive Edition</title>
    <script src="https://unpkg.com/kaboom@3000/dist/kaboom.js"></script>
    <style>
        body, html { margin: 0; padding: 0; overflow: hidden; background: #000; }
        canvas { display: block; max-width: 100vw; max-height: 100vh; }
    </style>
</head>
<body>
    <script>
        // Initialize Kaboom with advanced settings
        kaboom({
            width: 1024,
            height: 768,
            letterbox: true,
            touchToMouse: true,
            background: [5, 5, 15],
        });

        // --- ASSET LOADING ---
        loadSound("shot-sniper", "https://files.catbox.moe/u1z41p.mp3");
        loadSound("shot-rifle", "https://files.catbox.moe/3u5yjn.mp3");
        loadSound("hit", "https://files.catbox.moe/kwnz0q.mp3");
        loadSound("switch", "https://files.catbox.moe/s810gq.mp3");
        loadSound("empty", "https://files.catbox.moe/s92v2d.mp3");
        loadSound("steady", "https://files.catbox.moe/x92o93.mp3");
        loadMusic("ambient", "https://files.catbox.moe/p94ndz.mp3");
        loadMusic("action", "https://files.catbox.moe/6jw6k4.mp3");

        // --- GAME CONFIGURATION ---
        const GRAVITY = 1200;
        const weapons = {
            SNIPER: { ammo: 6, reload: 2, recoil: 30, sway: 3, damage: 100, sound: "shot-sniper" },
            RIFLE: { ammo: 20, reload: 1.5, recoil: 8, sway: 8, damage: 30, sound: "shot-rifle" },
        };
        const gameState = { score: 0, wave: 1, weapon: 'SNIPER', steadying: false };

        // --- SCENE: MENU ---
        scene("menu", () => {
            const music = play("ambient", { loop: true, volume: 0.6 });
            add([ text("IMPROVED SNIPER", { size: 64 }), pos(center().x, height() * 0.3), anchor("center") ]);
            const playBtn = add([ rect(240, 80, { radius: 10 }), pos(center()), outline(4), area(), anchor("center"), color(0, 150, 0) ]);
            add([ text("START", { size: 48 }), pos(center()), anchor("center") ]);
            
            playBtn.onClick(() => {
                music.stop();
                go("game");
            });
        });

        // --- SCENE: GAME ---
        scene("game", () => {
            const music = play("action", { loop: true, volume: 0.7 });
            let { score, wave, weapon } = { ...gameState };
            let currentAmmo = weapons[weapon].ammo;
            let reloading = false;
            let steadying = false;
            let targetsLeft = 0;

            // --- REALISTIC CAMERA SYSTEM ---
            const cam = { sway: vec2(0, 0), recoil: vec2(0, 0) };
            onUpdate(() => {
                const weaponData = weapons[weapon];
                const swayFactor = steadying ? 0.2 : 1;
                cam.sway.x = Math.sin(time() * 1.5) * weaponData.sway * swayFactor;
                cam.sway.y = Math.cos(time() * 2) * weaponData.sway * swayFactor;
                camPos(center().add(cam.sway).add(cam.recoil));
                cam.recoil = cam.recoil.lerp(vec2(0), dt() * 8); // Smoothly reduce recoil
            });

            function handleRecoil() {
                cam.recoil.y -= weapons[weapon].recoil;
            }

            // --- UI & FEEDBACK ---
            const scoreUI = add([ text(`Score: 0`), pos(20, 20), fixed(), z(100) ]);
            const ammoUI = add([ text(`Ammo: ${currentAmmo}`), pos(width() - 20, 20), fixed(), anchor("topright"), z(100) ]);
            const waveUI = add([ text(`Wave: 1`), pos(center().x, 20), fixed(), anchor("top"), z(100) ]);
            
            function showHitmarker() {
                const marker = add([
                    text("X", { size: 24 }), pos(center()), anchor("center"), color(255, 0, 0), lifespan(0.1), fixed(), z(200)
                ]);
            }
            
            function hapticFeedback(type = 'light') {
                if ('vibrate' in navigator) {
                    navigator.vibrate(type === 'heavy' ? [100, 50, 100] : 50);
                }
            }

            // --- GAME SYSTEMS ---
            function spawnTarget() {
                add([
                    rect(40, 40), pos(rand(50, width() - 50), rand(0, -200)), color(200, 50, 50), area(), outline(2), "target",
                    {
                        speed: rand(150, 300),
                        dir: rand(0.3, 0.7) * PI, // Move downwards
                        hp: 1 + Math.floor(wave / 3),
                    },
                ]);
            }
            
            function shatter(p, col) {
                for (let i = 0; i < 8; i++) {
                    add([
                        rect(rand(5, 10), rand(5, 10)), pos(p), color(col), rotate(rand(0, 360)),
                        move(rand(0, 360), rand(200, 400)),
                        lifespan(rand(0.5, 1.5)),
                        // Physics component
                        {
                            vel: vec2(rand(-300, 300), rand(-800, -400)),
                            update() {
                                this.vel.y += GRAVITY * dt();
                                this.pos = this.pos.add(this.vel.scale(dt()));
                                this.angle += this.vel.x * dt() * 0.2;
                            },
                        },
                    ]);
                }
            }

            onUpdate("target", (t) => {
                t.move(Vec2.fromAngle(t.dir).scale(t.speed));
                if (t.pos.y > height() + 50) destroy(t);
            });

            function shoot() {
                if (reloading || currentAmmo <= 0) {
                    if(!reloading) play("empty");
                    return;
                }

                currentAmmo--;
                handleRecoil();
                hapticFeedback('light');
                const weaponData = weapons[weapon];
                
                // Positional audio for the shot
                const pan = (camPos().x - center().x) / (width()/2);
                play(weaponData.sound, { pan: pan, volume: 0.8 });
                
                const hit = get("target").find(t => t.hasPoint(camPos()));
                if (hit) {
                    hapticFeedback('heavy');
                    showHitmarker();
                    hit.hp--;
                    const hitPan = (hit.pos.x - center().x) / (width()/2);
                    play("hit", { pan: hitPan });

                    if (hit.hp <= 0) {
                        shatter(hit.pos, hit.color);
                        destroy(hit);
                        targetsLeft--;
                        score += weaponData.damage;
                    }
                }
                
                if (currentAmmo <= 0) reload();
                updateAllUI();
            }
            
            function reload() {
                if (reloading) return;
                reloading = true;
                wait(weapons[weapon].reload, () => {
                    currentAmmo = weapons[weapon].ammo;
                    reloading = false;
                    updateAllUI();
                });
            }

            function startWave(w) {
                wave = w;
                targetsLeft = 3 + wave * 2;
                waveUI.text = `Wave: ${wave}`;
                for (let i = 0; i < targetsLeft; i++) {
                    wait(rand(0.2, 2.5), spawnTarget);
                }
            }

            // --- CONTROLS ---
            onMousePress(() => {
                play("steady", { volume: 0.5 });
                steadying = true;
            });
            onMouseRelease(() => {
                steadying = false;
                shoot();
            });
            onKeyPress("r", reload);
            onKeyPress("w", () => { // Switch weapon
                play("switch");
                weapon = weapon === 'SNIPER' ? 'RIFLE' : 'SNIPER';
                currentAmmo = weapons[weapon].ammo;
                reloading = false;
                updateAllUI();
            });

            // --- UI UPDATES ---
            function updateAllUI() {
                scoreUI.text = `Score: ${score}`;
                waveUI.text = `Wave: ${wave} | Targets: ${targetsLeft}`;
                ammoUI.text = reloading ? `RELOADING...` : `${weapon}: ${currentAmmo}`;
            }

            onUpdate(() => {
                if (targetsLeft <= 0) {
                    startWave(wave + 1);
                }
                updateAllUI();
            });

            startWave(1);
        });

        go("menu");
    </script>
</body>
</html>
