<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Telescope Sniper - Working Version</title>
    <script src="https://unpkg.com/kaboom@3000/dist/kaboom.js"></script>
    <style>
        body, html { 
            margin: 0; 
            padding: 0; 
            overflow: hidden; 
            background: #000; 
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
        }
        canvas { 
            border: 2px solid #333;
            max-width: 100vw;
            max-height: 100vh;
        }
    </style>
</head>
<body>
    <script>
        // Initialize Kaboom
        kaboom({
            width: 800,
            height: 600,
            background: [20, 20, 40],
            crisp: true
        });

        // Game state
        let gameState = {
            score: 0,
            ammo: 6,
            maxAmmo: 6,
            reloading: false,
            combo: 1,
            wave: 1,
            targetsLeft: 5,
            gameActive: false
        };

        // Create crosshair/scope
        const crosshair = add([
            pos(center()),
            circle(100),
            outline(4, RED),
            fixed(),
            z(100)
        ]);

        // Crosshair lines
        add([
            pos(center().sub(20, 0)),
            rect(40, 2),
            color(RED),
            fixed(),
            z(101)
        ]);
        add([
            pos(center().sub(0, 20)),
            rect(2, 40),
            color(RED),
            fixed(),
            z(101)
        ]);

        // UI Elements
        const scoreText = add([
            text("Score: 0", { size: 24 }),
            pos(20, 20),
            fixed(),
            z(100)
        ]);

        const ammoText = add([
            text("Ammo: 6/6", { size: 24 }),
            pos(width() - 20, 20),
            anchor("topright"),
            fixed(),
            z(100)
        ]);

        const waveText = add([
            text("Wave: 1", { size: 24 }),
            pos(center().x, 20),
            anchor("top"),
            fixed(),
            z(100)
        ]);

        // Fire button for mobile
        const fireButton = add([
            pos(width() - 80, height() - 80),
            circle(50),
            color(255, 0, 0, 0.7),
            outline(3, WHITE),
            area(),
            fixed(),
            z(200),
            "fireBtn"
        ]);

        add([
            text("FIRE", { size: 16 }),
            pos(width() - 80, height() - 80),
            anchor("center"),
            fixed(),
            z(201)
        ]);

        // Reload button
        const reloadButton = add([
            pos(width() - 200, height() - 80),
            rect(100, 60),
            color(0, 0, 255, 0.7),
            outline(3, WHITE),
            area(),
            fixed(),
            z(200),
            "reloadBtn"
        ]);

        add([
            text("RELOAD", { size: 14 }),
            pos(width() - 150, height() - 80),
            anchor("center"),
            fixed(),
            z(201)
        ]);

        // Instructions
        const instructions = add([
            text("Click to aim and shoot!\nUse FIRE button on mobile", { 
                size: 20, 
                align: "center" 
            }),
            pos(center().x, center().y + 150),
            anchor("center"),
            fixed(),
            z(100)
        ]);

        // Target spawning
        function spawnTarget() {
            const target = add([
                rect(40, 40),
                pos(rand(100, width() - 100), rand(100, height() - 100)),
                color(rand(100, 255), rand(50, 150), rand(50, 150)),
                area(),
                "target",
                {
                    speed: rand(50, 150),
                    direction: rand(0, 360)
                }
            ]);

            target.onUpdate(() => {
                target.move(
                    Math.cos(target.direction) * target.speed,
                    Math.sin(target.direction) * target.speed
                );

                // Bounce off walls
                if (target.pos.x < 0 || target.pos.x > width()) {
                    target.direction = Math.PI - target.direction;
                }
                if (target.pos.y < 0 || target.pos.y > height()) {
                    target.direction = -target.direction;
                }
            });

            return target;
        }

        // Shooting function
        function shoot(pos) {
            if (gameState.reloading || gameState.ammo <= 0) return;

            gameState.ammo--;
            
            // Check for hits
            const targets = get("target");
            let hit = false;

            targets.forEach(target => {
                if (target.hasPoint(pos)) {
                    // Hit!
                    destroy(target);
                    gameState.score += 100 * gameState.combo;
                    gameState.combo++;
                    gameState.targetsLeft--;
                    hit = true;

                    // Explosion effect
                    add([
                        circle(20),
                        pos(target.pos),
                        color(255, 255, 0),
                        lifespan(0.3),
                        scale(2)
                    ]);

                    // Score popup
                    add([
                        text(`+${100 * (gameState.combo - 1)}`, { size: 20 }),
                        pos(target.pos),
                        lifespan(1),
                        move(UP, 50),
                        color(GREEN)
                    ]);
                }
            });

            if (!hit) {
                gameState.combo = 1; // Reset combo on miss
            }

            // Auto reload when empty
            if (gameState.ammo === 0) {
                reload();
            }

            updateUI();
        }

        // Reload function
        function reload() {
            if (gameState.reloading) return;
            
            gameState.reloading = true;
            wait(2, () => {
                gameState.ammo = gameState.maxAmmo;
                gameState.reloading = false;
                updateUI();
            });
        }

        // Update UI
        function updateUI() {
            scoreText.text = `Score: ${gameState.score}`;
            ammoText.text = gameState.reloading ? "RELOADING..." : `Ammo: ${gameState.ammo}/${gameState.maxAmmo}`;
            waveText.text = `Wave: ${gameState.wave} | Targets: ${gameState.targetsLeft}`;
            
            // Update button colors
            fireButton.color = gameState.ammo > 0 ? rgb(255, 0, 0, 0.7) : rgb(100, 0, 0, 0.7);
        }

        // Start new wave
        function startWave() {
            gameState.targetsLeft = 3 + gameState.wave * 2;
            for (let i = 0; i < gameState.targetsLeft; i++) {
                wait(i * 0.5, () => spawnTarget());
            }
        }

        // Input handling
        onClick(() => {
            if (!gameState.gameActive) {
                gameState.gameActive = true;
                destroy(instructions);
                startWave();
                return;
            }
            shoot(mousePos());
        });

        onClick("fireBtn", () => {
            shoot(center());
        });

        onClick("reloadBtn", () => {
            reload();
        });

        // Game loop
        onUpdate(() => {
            if (gameState.gameActive && gameState.targetsLeft <= 0) {
                // Wave complete
                gameState.wave++;
                wait(1, () => startWave());
            }
        });

        // Initialize
        updateUI();
    </script>
</body>
</html>
